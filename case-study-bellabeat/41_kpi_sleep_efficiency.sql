USE BellaBeat; GO WITH ds AS (SELECT a.activity_date, s.TotalMinutesAsleep, s.TotalTimeInBed FROM dbo.v_daily_activity a LEFT JOIN dbo.v_sleep s ON a.Id = s.Id AND a.activity_date = s.sleep_date WHERE s.TotalTimeInBed > 0) SELECT CONVERT(decimal(4,2), AVG(1.0 * TotalMinutesAsleep / TotalTimeInBed)) AS avg_sleep_efficiency, CONVERT(decimal(10,1), AVG(1.0 * (TotalTimeInBed - TotalMinutesAsleep))) AS avg_minutes_awake_in_bed FROM ds;